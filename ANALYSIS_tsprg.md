# Анализ директории tsprg и сравнение с текущей реализацией

## Что находится в `tsprg/`

### Старые скрипты (GDL/TS) для обработки кассет:

1. **`make_sizes.cpp`** - Планки типа 0 (OK-0_PLNK)
   - Читает из Excel: Лист1, столбец B (20 строк)
   - Группирует уникальные размеры и считает количество
   - Записывает в объект OK-0_PLNK: Text_3...Text_10 (8 значений)
   - Формат строки: `"Размер: 285×{value} мм; Длина Z = {value} мм; Количество: {cnt} шт."`
   - value = val * 1000 + 50

2. **`make_sizes_lotk.cpp`** - Левые откосы типа 0 (OK-0_LOTK)
   - Читает из Excel: Лист1, столбец C (20 строк)
   - Записывает в объект OK-0_LOTK: Text_3...Text_10 (8 значений)
   - Формат: `"Размер: 285×{value} мм; Длина Z = {value} мм; Количество: {cnt} шт."`
   - value = val * 1000

3. **`make_sizes_rotk.cpp`** - Правые откосы типа 0 (OK-0_ROTK)
   - Читает из Excel: Лист1, столбец C (20 строк)
   - Записывает в объект OK-0_ROTK: Text_3...Text_10 (8 значений)
   - Формат: `"Размер: 285×{value} мм; Длина Z = {value} мм; Количество: {cnt} шт."`
   - value = val * 1000

4. **`make_sizes_plnk_1_2.cpp`** - Планки типов 1 и 2 (OK-1_2_PLNK)
   - Читает из Excel: Лист2 и Лист3, столбец B (20 строк каждый)
   - Записывает в объект OK-1_2_PLNK: Text_3...Text_10 (8 значений)
   - Формат: `"Размер: 160×{value} мм; Длина W = {value} мм; Количество: {cnt} шт."`
   - value = val * 1000 + 50
   - **Важно:** Для каждого листа добавляется по 2 штуки (oldcnt + 2)

5. **`make_sizes_lotk_1_2.cpp`** - Левые откосы типов 1 и 2 (OK-1_2_LOTK)
   - Читает из Excel: Лист2 и Лист3, столбец C (20 строк каждый)
   - Записывает в объект OK-1_2_LOTK: Text_3...Text_16 (16 значений)
   - Формат: `"Размер: 225×{value} мм; Длина Z = {value} мм; Количество: {cnt} шт."`
   - value = val * 1000

6. **`make_sizes_rotk_1_2.cpp`** - Правые откосы типов 1 и 2 (OK-1_2_ROTK)
   - Читает из Excel: Лист2 и Лист3, столбец C (20 строк каждый)
   - Записывает в объект OK-1_2_ROTK: Text_3...Text_16 (16 значений)
   - Формат: `"Размер: 225×{value} мм; Длина Z = {value} мм; Количество: {cnt} шт."`
   - value = val * 1000

7. **`make_sizes_cass_set.cpp`** - Кассеты (OK-1_2_CASS)
   - Читает из Excel: 
     - Лист1, ячейка I2 (высота этажа)
     - Лист2: столбцы B, C, D → X, Y (X = D*1000 + 195 - 30, Y = B*1000 + 50)
     - Лист3: столбцы B, C, D → X1, X2, Y (X1 = D*1000 + 195 - 30, X2 = I2*1000 - (190 + C*1000 + D*1000 + 20) + 745, Y = B*1000 + 50)
   - Группирует по (X, Y) и считает количество
   - Записывает в объект OK-1_2_CASS: Text_3...Text_18 (16 значений)
   - Формат: `"Размер: U x V : {X}×{Y} мм; Количество: {Z} шт."`

### Другие файлы:
- `config.cpp`, `dimensions.cpp`, `floor_height.cpp` - не удалось прочитать (кодировка)
- `open_excel_file.cpp` - не удалось прочитать (кодировка)
- `panel_creation.cpp`, `prm_to_excel.cpp`, `ac_to_excel_1.cpp` - не найдены

## Найденные проблемы в текущей реализации

### ✅ ИСПРАВЛЕНО: Формат строк в WriteToTargetObjects

**Проблема:** Формат строк не совпадал со старыми скриптами.

**Было:**
- Планки: `"Размер: %dx%d мм; Длина Z = %d мм; Количество: %d шт."` (неправильный формат, 4 параметра вместо правильного)
- Откосы: аналогично

**Стало:**
- Планки типа 0: `"Размер: 285×{length} мм; Длина Z = {length} мм; Количество: {count} шт."`
- Планки типов 1-2: `"Размер: 160×{length} мм; Длина W = {length} мм; Количество: {count} шт."` ✅
- Откосы: `"Размер: {width}×{length} мм; Длина Z = {length} мм; Количество: {count} шт."` ✅
- Кассеты: `"Размер: U x V : {X}×{Y} мм; Количество: {Z} шт."` ✅

### ⚠️ ПРОВЕРИТЬ: Лимиты записей

**Старые скрипты:**
- Тип 0: 8 значений (Text_3...Text_10)
- Типы 1-2: 16 значений для откосов и кассет (Text_3...Text_18), 8 для планок

**Текущая реализация:**
- Тип 0: maxOthers = 8 ✅
- Типы 1-2: maxCassettes = 16, maxOthers = 16 ✅

**Проблема:** Для планок типов 1-2 должно быть 8, а не 16! Но в старом скрипте `make_sizes_plnk_1_2.cpp` действительно используется 8 (Text_3...Text_10).

### ⚠️ ПРОВЕРИТЬ: Формулы расчёта

**Кассеты:**
- X = D * 1000 + 195 - 30 = D * 1000 + 165 ✅ (offsetX = 165)
- Y = B * 1000 + 50 ✅ (offsetY = 50)
- X2 = I2*1000 - (190 + C*1000 + D*1000 + 20) + 745 ✅

**Планки:**
- Длина = B * 1000 + 50 ✅ (offsetY = 50)

**Откосы:**
- Длина = C * 1000 ✅

### ⚠️ ПРОВЕРИТЬ: Количество элементов

**Старые скрипты:**
- Планки: по 2 на каждое окно ✅
- Откосы: по 1 левый и 1 правый на каждое окно ✅
- Кассеты: 1 на окно типа 1, 2 на окно типа 2 ✅

### ⚠️ ПРОВЕРИТЬ: Ширина профилей

**Тип 0:**
- Планки: 285 мм ✅
- Откосы: 285 мм ✅

**Типы 1-2:**
- Планки: 160 мм ✅
- Откосы: 225 мм ✅

## Что упущено в плане

### План `Send_xls_plan.md` относится к другой функциональности
Этот план про экспорт выделенных элементов в Excel, а не про расчёт кассет.

### ✅ ИСПРАВЛЕНО: Интеграция с BrowserRepl

**Проблема:** В HTML палитре были TODO комментарии вместо реальных вызовов C++ функций.

**Исправлено:**
- ✅ Добавлена функция `CalculateCassettes` в BrowserRepl.cpp
- ✅ Добавлена функция `WriteCassetteResults` в BrowserRepl.cpp
- ✅ Обновлена HTML палитра для использования реальных вызовов
- ✅ Добавлена обработка дубликатов ID в UI

### ✅ ИСПРАВЛЕНО: Лимит записей для планок

**Проблема:** Для планок типов 1-2 использовался лимит 16, а должно быть 8.

**Исправлено:**
- ✅ Добавлены отдельные лимиты: `maxPlanks = 8` (всегда), `maxSlopes = 8/16` (зависит от типа)

### ✅ ПРОВЕРЕНО: Интеграция с HTML палитрой

- ✅ `GetCassetteSelection` - реализована и используется
- ✅ `GetFloorHeightFromWall` - реализована и используется
- ✅ `CalculateCassettes` - реализована и используется
- ✅ `WriteCassetteResults` - реализована и используется

## Итоговый статус

### ✅ Исправлено:
1. ✅ Формат строк в WriteToTargetObjects (соответствует старым скриптам)
2. ✅ Лимит записей для планок (8 для всех типов)
3. ✅ Интеграция с BrowserRepl (добавлены все необходимые функции)
4. ✅ Интеграция с HTML палитрой (используются реальные C++ функции)

### ⚠️ Требует проверки:
1. ⚠️ Протестировать все формулы расчёта на реальных данных
2. ⚠️ Проверить работу GetFloorHeightFromWall с разными ID стен
3. ⚠️ Проверить обработку дубликатов ID
4. ⚠️ Добавить тесты для сравнения результатов со старыми скриптами
5. ⚠️ Проверить работу с разными типами окон (ОК-0, ОК-1, ОК-2, ДВ-0, ДВ-1, ДВ-2)
